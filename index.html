<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Instagram Widget</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--ig-border:#dbdbdb;--ig-text:#000;--ig-muted:#737373;--ig-bg:#fff;--ig-surface:#fafafa;--ig-blue:#0095f6;--ig-red:#ed4956;--story-gradient:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);--font:'Inter',-apple-system,BlinkMacSystemFont,sans-serif}
html,body{font-family:var(--font);background:#fff;color:var(--ig-text);max-width:470px;margin:0 auto;min-height:100vh;overflow-x:hidden}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;display:none;align-items:flex-end;max-width:470px;margin:0 auto}
.modal-overlay.open{display:flex}
.modal-sheet{background:#fff;border-radius:20px 20px 0 0;width:100%;max-height:92vh;overflow-y:auto;animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:#d0d0d0;border-radius:2px;margin:10px auto 0}
.modal-header{display:flex;align-items:center;padding:14px 16px 12px;border-bottom:1px solid var(--ig-border)}
.modal-title{font-size:16px;font-weight:700;flex:1;text-align:center}
.modal-close{background:none;border:none;font-size:15px;color:var(--ig-blue);font-weight:600;cursor:pointer;font-family:var(--font);min-width:60px}
.modal-body{padding:16px}

/* FORMS */
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.field label{font-size:12px;font-weight:600;color:var(--ig-muted);text-transform:uppercase;letter-spacing:.6px}
.field input,.field textarea,.field select{border:1px solid var(--ig-border);border-radius:8px;padding:10px 12px;font-size:14px;color:var(--ig-text);background:var(--ig-surface);outline:none;transition:border-color .15s;font-family:var(--font);resize:none;line-height:1.5;width:100%}
.field input:focus,.field textarea:focus{border-color:#000;background:#fff}
.field input::placeholder,.field textarea::placeholder{color:#c0c0c0}
.field-hint{font-size:11px;color:var(--ig-muted);line-height:1.4}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-primary{width:100%;background:var(--ig-blue);color:#fff;border:none;border-radius:8px;padding:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.btn-danger{background:#fff;color:var(--ig-red);border:1px solid var(--ig-red);border-radius:8px;padding:10px;font-size:14px;font-weight:600;cursor:pointer;width:100%;font-family:var(--font);margin-top:8px}
.btn-demo{width:100%;background:transparent;color:var(--ig-blue);border:1px solid var(--ig-border);border-radius:8px;padding:11px;font-size:14px;font-weight:600;cursor:pointer;margin-top:10px;font-family:var(--font)}
.form-error{background:#fff0f0;border:1px solid #ffcdd2;border-radius:8px;padding:10px 12px;font-size:13px;color:#c0392b;line-height:1.6;white-space:pre-line;margin-bottom:12px}
.form-section{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--ig-muted);padding:14px 0 8px;border-top:1px solid var(--ig-border);margin-top:4px}

/* SETUP */
#setupOverlay{position:fixed;inset:0;background:#fff;z-index:999;display:none;flex-direction:column;overflow-y:auto}
#setupOverlay.open{display:flex}
.setup-header{padding:14px 16px;border-bottom:1px solid var(--ig-border);display:flex;align-items:center;gap:10px}
.setup-logo{font-size:22px;font-weight:700;font-family:Georgia,serif;font-style:italic}
.setup-tag{font-size:11px;background:#f0f0f0;padding:3px 8px;border-radius:4px;color:var(--ig-muted);font-weight:500}
.setup-body{padding:20px 16px;flex:1}
.setup-title{font-size:17px;font-weight:600;margin-bottom:4px}
.setup-sub{font-size:13px;color:var(--ig-muted);margin-bottom:20px;line-height:1.5}
.setup-divider{display:flex;align-items:center;gap:10px;color:var(--ig-muted);font-size:13px;margin:16px 0}
.setup-divider::before,.setup-divider::after{content:'';flex:1;height:1px;background:var(--ig-border)}
.setup-help{background:#fafafa;border-radius:10px;padding:12px 14px;font-size:12px;color:var(--ig-muted);line-height:1.8;margin-top:20px}
.setup-help strong{color:var(--ig-text)}
.setup-help code{background:#efefef;padding:1px 5px;border-radius:4px;font-size:11px}

/* HEADER */
.ig-header{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--ig-border);padding:12px 16px;display:flex;align-items:center;z-index:100}
.ig-logo{font-size:20px;font-weight:700;font-family:Georgia,serif;font-style:italic;flex:1;letter-spacing:-.5px;cursor:pointer;display:flex;align-items:center;gap:5px}
.ig-logo-chevron{font-size:12px;color:var(--ig-muted);transition:transform .2s;line-height:1}
.ig-header-actions{display:flex;gap:16px;align-items:center;margin-left:auto}
.ig-icon-btn{background:none;border:none;cursor:pointer;display:flex;align-items:center;color:var(--ig-text)}
.ig-icon-btn svg{width:24px;height:24px}

/* PROFILE DROPDOWN */
.profile-dd{position:absolute;top:52px;left:0;right:0;background:#fff;border-bottom:1px solid var(--ig-border);box-shadow:0 4px 12px rgba(0,0,0,.08);z-index:99;display:none;max-width:470px;margin:0 auto}
.profile-dd.open{display:block}
.pd-item{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:background .15s}
.pd-item:hover{background:var(--ig-surface)}
.pd-item.active{background:#f0f8ff}
.pd-av{width:40px;height:40px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0;border:1px solid var(--ig-border)}
.pd-av img{width:100%;height:100%;object-fit:cover}
.pd-info{flex:1;min-width:0}
.pd-name{font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pd-sub{font-size:12px;color:var(--ig-muted)}
.pd-check{color:var(--ig-blue);font-size:18px;font-weight:700}
.pd-add-row{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;color:var(--ig-blue);font-size:14px;font-weight:600;border-top:1px solid var(--ig-border)}
.pd-add-icon{width:40px;height:40px;border-radius:50%;border:1.5px dashed var(--ig-blue);display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--ig-blue)}

/* PROFILE */
.ig-profile{padding:16px}
.ig-profile-top{display:flex;align-items:center;gap:20px;margin-bottom:14px}
.ig-av-ring{width:82px;height:82px;border-radius:50%;padding:2.5px;background:var(--story-gradient);cursor:pointer;flex-shrink:0}
.ig-av-ring.no-story{background:var(--ig-border);padding:1.5px}
.ig-av-inner{width:100%;height:100%;border-radius:50%;border:2.5px solid #fff;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden}
.ig-av-inner img{width:100%;height:100%;object-fit:cover}
.ig-stats{display:flex;flex:1;justify-content:space-around}
.ig-stat{text-align:center;cursor:pointer}
.ig-stat-val{font-size:17px;font-weight:700;display:block;line-height:1.2}
.ig-stat-lbl{font-size:12px;color:var(--ig-text)}
.ig-profile-name{font-size:14px;font-weight:700;margin-bottom:3px}
.ig-profile-bio{font-size:14px;line-height:1.5;white-space:pre-line;margin-bottom:4px}
.ig-profile-link{font-size:14px;color:var(--ig-blue);font-weight:500;text-decoration:none;display:none;margin-bottom:2px}
.ig-profile-actions{display:flex;gap:6px;margin-top:14px}
.ig-btn{flex:1;border-radius:8px;padding:7px 10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--ig-border);background:#efefef;color:var(--ig-text);text-align:center;font-family:var(--font)}
.ig-btn.icon-only{flex:none;width:36px;padding:7px;display:flex;align-items:center;justify-content:center}

/* STORY GROUPS */
.sg-bar{border-top:1px solid var(--ig-border);border-bottom:1px solid var(--ig-border);padding:12px 0 14px;overflow-x:auto;scrollbar-width:none;display:none}
.sg-bar.visible{display:block}
.sg-bar::-webkit-scrollbar{display:none}
.sg-inner{display:flex;gap:4px;padding:0 12px}
.sg-item{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;flex-shrink:0;width:72px;animation:fadeIn .3s ease both}
.sg-ring{width:62px;height:62px;border-radius:50%;padding:2px;background:var(--story-gradient)}
.sg-ring.seen{background:#c7c7c7}
.sg-thumb{width:100%;height:100%;border-radius:50%;border:2px solid #fff;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
.sg-thumb img{width:100%;height:100%;object-fit:cover}
.sg-name{font-size:11px;color:var(--ig-text);text-align:center;width:68px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* TABS */
.ig-tabs{display:flex;border-bottom:1px solid var(--ig-border)}
.ig-tab{flex:1;display:flex;align-items:center;justify-content:center;padding:12px;cursor:pointer;border-bottom:1px solid transparent;margin-bottom:-1px;color:#a0a0a0}
.ig-tab svg{width:22px;height:22px}
.ig-tab.active{border-bottom-color:var(--ig-text);color:var(--ig-text)}

/* GRID */
.ig-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px}
.ig-grid-item{position:relative;aspect-ratio:1;background:#f0f0f0;cursor:pointer;overflow:hidden;animation:fadeIn .3s ease both}
.ig-grid-item img{width:100%;height:100%;object-fit:cover;display:block}
.ig-grid-emoji{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:38px;background:#f5f5f5}
.ig-grid-badge{position:absolute;top:6px;right:6px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.5))}
.ig-grid-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;gap:16px;opacity:0;transition:opacity .2s;color:#fff;font-weight:700;font-size:14px}
.ig-grid-item:hover .ig-grid-overlay{opacity:1}
.ig-grid-empty{aspect-ratio:1;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:13px;color:#c7c7c7}

/* REELS */
.ig-reels-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px}
.ig-reel-item{position:relative;aspect-ratio:9/16;background:#000;cursor:pointer;overflow:hidden;animation:fadeIn .3s ease both}
.ig-reel-item img{width:100%;height:100%;object-fit:cover;opacity:.85}
.ig-reel-emoji{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:36px;background:#1a1a1a}
.ig-reel-play{position:absolute;top:6px;right:6px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.5))}
.ig-reel-views{position:absolute;bottom:6px;left:6px;color:#fff;font-size:12px;font-weight:600;text-shadow:0 1px 3px rgba(0,0,0,.5)}

/* EMPTY */
.ig-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:12px;color:var(--ig-muted);text-align:center}
.ig-empty-icon{width:62px;height:62px;border-radius:50%;border:2px solid var(--ig-text);display:flex;align-items:center;justify-content:center}
.ig-empty-icon svg{width:28px;height:28px}
.ig-empty h3{font-size:20px;font-weight:300;color:var(--ig-text)}
.ig-empty p{font-size:14px;line-height:1.5}

/* LOADING */
.ig-loading{display:flex;align-items:center;justify-content:center;padding:60px}
.ig-spinner{width:28px;height:28px;border:2.5px solid #f0f0f0;border-top-color:var(--ig-blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* STORY MODAL */
.story-modal{display:none;position:fixed;inset:0;background:#000;z-index:9999;flex-direction:column;max-width:470px;margin:0 auto}
.story-modal.open{display:flex}
.story-bars{display:flex;gap:3px;padding:10px 10px 0;position:absolute;top:0;left:0;right:0;z-index:10}
.story-bar{flex:1;height:2px;background:rgba(255,255,255,.3);border-radius:2px;overflow:hidden}
.story-bar-fill{height:100%;background:#fff;width:0;border-radius:2px}
.story-bar-fill.done{width:100%}
.story-bar-fill.active{animation:storyP 5s linear forwards}
@keyframes storyP{to{width:100%}}
.story-hdr{position:absolute;top:18px;left:12px;right:12px;display:flex;align-items:center;gap:8px;z-index:10}
.story-av{width:34px;height:34px;border-radius:50%;border:1.5px solid #fff;background:#333;display:flex;align-items:center;justify-content:center;font-size:16px;overflow:hidden;flex-shrink:0}
.story-av img{width:100%;height:100%;object-fit:cover}
.story-uname{font-size:14px;font-weight:600;color:#fff;flex:1;text-shadow:0 1px 3px rgba(0,0,0,.4)}
.story-time-lbl{font-size:11px;color:rgba(255,255,255,.75)}
.story-close-btn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:4px;line-height:1}
.story-nav{position:absolute;top:0;bottom:0;width:40%;z-index:5;cursor:pointer}
.story-nav.prev{left:0}
.story-nav.next{right:0}
.story-media{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.story-media img{max-width:100%;max-height:100%;object-fit:contain}
.story-big-emoji{font-size:100px}
.story-caption{position:absolute;bottom:20px;left:16px;right:16px;color:#fff;font-size:15px;font-weight:500;text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.6);line-height:1.4}
.story-footer{padding:12px 16px 24px;display:flex;align-items:center;gap:12px}
.story-reply{flex:1;border:1.5px solid rgba(255,255,255,.5);border-radius:22px;background:transparent;padding:9px 16px;color:#fff;font-size:14px;font-family:var(--font);outline:none}
.story-reply::placeholder{color:rgba(255,255,255,.6)}
.story-icon{font-size:24px;cursor:pointer}

/* POST MODAL */
.post-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9998;align-items:flex-end;max-width:470px;margin:0 auto}
.post-modal.open{display:flex}
.post-sheet{background:#fff;border-radius:16px 16px 0 0;width:100%;max-height:92vh;overflow-y:auto;animation:slideUp .25s ease}
.post-handle{width:36px;height:4px;background:#d0d0d0;border-radius:2px;margin:10px auto 0}
.post-hdr{display:flex;align-items:center;gap:10px;padding:12px 14px 10px;border-bottom:1px solid var(--ig-border)}
.post-av{width:38px;height:38px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;overflow:hidden}
.post-av img{width:100%;height:100%;object-fit:cover}
.post-uname{font-size:14px;font-weight:600}
.post-date-lbl{font-size:12px;color:var(--ig-muted)}
.post-close-btn{background:none;border:none;font-size:22px;cursor:pointer;line-height:1}
.post-media{aspect-ratio:1;background:#f5f5f5;display:flex;align-items:center;justify-content:center;overflow:hidden}
.post-media img{width:100%;height:100%;object-fit:cover}
.post-big-emoji{font-size:80px}
.post-type-lbl{padding:8px 14px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ig-muted)}
.post-actions{display:flex;align-items:center;padding:10px 14px 6px;gap:14px}
.post-action-btn{background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:5px}
.post-action-btn svg{width:24px;height:24px}
.post-action-btn span{font-size:13px;font-weight:600}
.post-likes-lbl{padding:0 14px 6px;font-size:14px;font-weight:600}
.post-caption{padding:0 14px 10px;font-size:14px;line-height:1.5}
.post-caption strong{font-weight:700}
.post-comments-lbl{padding:0 14px 16px;font-size:14px;color:var(--ig-muted);cursor:pointer}

/* FOOTER */
.ig-footer{text-align:center;padding:20px;border-top:1px solid var(--ig-border);margin-top:16px}
.ig-footer a{color:#c7c7c7;text-decoration:none;font-size:12px}

/* AVATAR PICKER */
.av-picker{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.av-opt{font-size:28px;cursor:pointer;padding:6px;border-radius:8px;border:2px solid transparent;transition:border-color .15s}
.av-opt.selected{border-color:var(--ig-blue)}

/* STORY GROUP MANAGER */
.sgm-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.sgm-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--ig-border);border-radius:10px;background:var(--ig-surface)}
.sgm-icon{font-size:22px;flex-shrink:0}
.sgm-info{flex:1;min-width:0}
.sgm-name{font-size:14px;font-weight:600}
.sgm-count{font-size:12px;color:var(--ig-muted)}
.sgm-del{background:none;border:none;color:var(--ig-muted);font-size:18px;cursor:pointer;padding:4px}
.sgm-add{display:flex;gap:8px;margin-top:4px}
.sgm-add input{flex:1;border:1px solid var(--ig-border);border-radius:8px;padding:10px 12px;font-size:14px;outline:none;font-family:var(--font)}
.sgm-add button{background:var(--ig-blue);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--font);white-space:nowrap}

@keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setupOverlay">
  <div class="setup-header">
    <div class="setup-logo">Instagram</div>
    <div class="setup-tag">√ó Notion</div>
  </div>
  <div class="setup-body">
    <div class="setup-title">Ajouter un profil</div>
    <div class="setup-sub">Connecte une base Notion pour afficher tes contenus Instagram.</div>
    <div class="field"><label>üë§ Nom du compte</label><input type="text" id="cfgUsername" placeholder="mon_compte"></div>
    <div class="field"><label>üîë Cl√© secr√®te de l'int√©gration</label><input type="password" id="cfgKey" placeholder="secret_xxx ou ntn_xxx"><div class="field-hint">notion.so/my-integrations ‚Üí Internal ‚Üí copie le secret</div></div>
    <div class="field"><label>üóÉÔ∏è ID de la base de donn√©es</label><input type="text" id="cfgDb" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"><div class="field-hint">Dans l'URL Notion apr√®s le dernier / et avant le ?</div></div>
    <div class="field"><label>üìù Bio (3 lignes max)</label><textarea id="cfgBio" rows="3" placeholder="üöÄ Cr√©ateur de contenu&#10;üì∏ Planning Instagram&#10;üìç Paris, France"></textarea></div>
    <div id="setupError"></div>
    <button class="btn-primary" id="setupBtn" onclick="connectNotion()">Se connecter √† Notion</button>
    <div class="setup-divider"><span>OU</span></div>
    <button class="btn-demo" onclick="loadDemo()">Voir la d√©mo</button>
    <div class="setup-help"><strong>Colonnes Notion :</strong><br><code>TITRE</code> ¬∑ <code>FORMAT</code> (Article/Carrousel/Reel/Story) ¬∑ <code>IMAGE</code> (fichier) ¬∑ <code>J'AIME</code> ¬∑ <code>COMMENTAIRES</code> ¬∑ <code>PUBLIER LE</code></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="ig-header">
    <div class="ig-logo" onclick="toggleDD()">
      <span id="appUsername">Instagram</span>
      <span class="ig-logo-chevron" id="logoChevron">‚ñæ</span>
    </div>
    <div class="ig-header-actions">
<button class="ig-icon-btn" onclick="refreshFeed()" title="Actualiser">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      </button>
    </div>
  </div>

  <div class="profile-dd" id="profileDD">
    <div id="ddList"></div>
    <div class="pd-add-row" onclick="addProfile()">
      <div class="pd-add-icon">+</div>
      <span>Ajouter un compte</span>
    </div>
  </div>

  <div class="ig-profile">
    <div class="ig-profile-top">
      <div class="ig-av-ring" id="avRing" onclick="openFirstStory()">
        <div class="ig-av-inner" id="avInner">üì∑</div>
      </div>
      <div class="ig-stats">
        <div class="ig-stat"><span class="ig-stat-val" id="statPosts">0</span><span class="ig-stat-lbl">publications</span></div>
        <div class="ig-stat"><span class="ig-stat-val" id="statFollowers">0</span><span class="ig-stat-lbl">abonn√©s</span></div>
        <div class="ig-stat"><span class="ig-stat-val" id="statFollowing">0</span><span class="ig-stat-lbl">suivi(e)s</span></div>
      </div>
    </div>
    <div class="ig-profile-name" id="profName"></div>
    <div class="ig-profile-bio" id="profBio"></div>
    <a class="ig-profile-link" id="profLink" target="_blank"></a>
    <div class="ig-profile-actions">
      <button class="ig-btn" onclick="openEdit()">Modifier le profil</button>
      <button class="ig-btn" onclick="addProfile()">Ajouter un profil</button>
      <button class="ig-btn icon-only" onclick="openSGM()" title="Groupes de stories">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="8" r="4"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="18" r="3"/></svg>
      </button>
    </div>
  </div>

  <div class="sg-bar" id="sgBar"><div class="sg-inner" id="sgInner"></div></div>

  <div class="ig-tabs">
    <div class="ig-tab active" id="tabGrid" onclick="switchTab('grid')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    </div>
    <div class="ig-tab" id="tabReels" onclick="switchTab('reels')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18"/><path d="M7 2v20M17 2v20M2 12h20M2 7h5M2 17h5M17 17h5M17 7h5"/></svg>
    </div>
    <div class="ig-tab" id="tabTagged" onclick="switchTab('tagged')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
    </div>
  </div>
  <div id="contentArea"></div>
  <div class="ig-footer"><a href="https://bychanael.fr" target="_blank">bychanael</a></div>
</div>

<!-- STORY MODAL -->
<div class="story-modal" id="storyModal">
  <div class="story-bars" id="storyBars"></div>
  <div class="story-hdr">
    <div class="story-av" id="storyAv"></div>
    <div><div class="story-uname" id="storyUname"></div><div class="story-time-lbl" id="storyTime"></div></div>
    <button class="story-close-btn" onclick="closeStory()">‚úï</button>
  </div>
  <div class="story-nav prev" onclick="prevStory()"></div>
  <div class="story-nav next" onclick="nextStory()"></div>
  <div class="story-media" id="storyMedia"></div>
  <div class="story-footer">
    <input class="story-reply" placeholder="R√©pondre √† la story‚Ä¶">
    <span class="story-icon">‚ù§Ô∏è</span>
    <span class="story-icon">üì§</span>
  </div>
</div>

<!-- POST MODAL -->
<div class="post-modal" id="postModal" onclick="if(event.target===this)closePost()">
  <div class="post-sheet">
    <div class="post-handle"></div>
    <div class="post-hdr">
      <div class="post-av" id="postAv"></div>
      <div style="flex:1"><div class="post-uname" id="postUname"></div><div class="post-date-lbl" id="postDateLbl"></div></div>
      <button class="post-close-btn" onclick="closePost()">‚úï</button>
    </div>
    <div class="post-media" id="postMedia"></div>
    <div class="post-type-lbl" id="postTypeLbl"></div>
    <div class="post-actions">
      <button class="post-action-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span id="postLikes"></span></button>
      <button class="post-action-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span id="postComments"></span></button>
      <button class="post-action-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
      <button class="post-action-btn" style="margin-left:auto"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="19 21 12 16 5 21 5 3 19 3 19 21"/></svg></button>
    </div>
    <div class="post-likes-lbl" id="postLikesLbl"></div>
    <div class="post-caption" id="postCap"></div>
    <div class="post-comments-lbl" id="postCommentsLbl"></div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('editModal')" style="text-align:left">Annuler</button>
      <div class="modal-title">Modifier le profil</div>
      <button class="modal-close" onclick="saveProfile()" style="text-align:right">Enregistrer</button>
    </div>
    <div class="modal-body">
      <div class="form-section" style="border-top:none;padding-top:0">Photo de profil</div>
      <div class="av-picker" id="avPicker"></div>
      <div class="field"><label>Ou URL d'image</label><input type="url" id="editAvUrl" placeholder="https://..."></div>
      <div class="form-section">Infos</div>
      <div class="field"><label>Nom affich√©</label><input type="text" id="editDisplayName"></div>
      <div class="field"><label>Nom d'utilisateur</label><input type="text" id="editUsername"></div>
      <div class="field"><label>Bio</label><textarea id="editBio" rows="3"></textarea></div>
      <div class="field"><label>Lien</label><input type="url" id="editLink" placeholder="https://bychanael.fr"></div>
      <div class="form-section">Statistiques</div>
      <div class="field-row">
        <div class="field"><label>Abonn√©s</label><input type="text" id="editFollowers"></div>
        <div class="field"><label>Suivi(e)s</label><input type="text" id="editFollowing"></div>
      </div>
      <div class="form-section">Connexion Notion</div>
      <div class="field"><label>üîë Cl√© API</label><input type="password" id="editKey" placeholder="secret_xxx ou ntn_xxx"></div>
      <div class="field"><label>üóÉÔ∏è ID de la base</label><input type="text" id="editDb"></div>
      <div id="editError"></div>
      <button class="btn-danger" onclick="deleteProfile()">üóë Supprimer ce profil</button>
    </div>
  </div>
</div>

<!-- STORY GROUP MANAGER -->
<div class="modal-overlay" id="sgModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('sgModal')">Fermer</button>
      <div class="modal-title">Groupes de stories</div>
      <div style="min-width:60px"></div>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--ig-muted);margin-bottom:14px;line-height:1.5">Les stories dont la l√©gende contient le nom du groupe seront regroup√©es ici.</p>
      <div class="sgm-list" id="sgmList"></div>
      <div class="sgm-add">
        <input type="text" id="sgmInput" placeholder="Nom du groupe (ex: Voyages)" maxlength="20" onkeydown="if(event.key==='Enter')addSG()">
        <button onclick="addSG()">+ Ajouter</button>
      </div>
    </div>
  </div>
</div>

<script>
const SKEY='ig_v3', AVATARS=['üì∑','üë§','‚ú®','üåü','üé®','üöÄ','üí´','üå∏','üé≠','ü¶ã','üåà','üî•']
const $=id=>document.getElementById(id)
const fmt=n=>!n?'0':n>=1e6?(n/1e6).toFixed(1)+'M':n>=1000?(n/1000).toFixed(1)+'K':String(n)
const uid=()=>Math.random().toString(36).slice(2,9)

let S={profiles:[],cur:null,tab:'grid',storyItems:[],storyIdx:null,storyTimer:null,seen:{},ddOpen:false}

// PERSIST
function save(){localStorage.setItem(SKEY,JSON.stringify({profiles:S.profiles,cur:S.cur,seen:S.seen}))}
function load(){
  try{const d=JSON.parse(localStorage.getItem(SKEY)||'null');if(d?.profiles?.length){S.profiles=d.profiles;S.cur=d.cur||d.profiles[0].id;S.seen=d.seen||{};return true}}catch{}
  return false
}
const curP=()=>S.profiles.find(p=>p.id===S.cur)||S.profiles[0]

// NOTION
function mapNotion(results){
  return results.map(page=>{
    const p=page.properties
    const g=(...keys)=>{for(const k of keys){const prop=p[k];if(!prop)continue;if(prop.title?.length)return prop.title.map(t=>t.plain_text).join('');if(prop.rich_text?.length)return prop.rich_text.map(t=>t.plain_text).join('');if(prop.select)return prop.select?.name||'';if(prop.number!==undefined&&prop.number!==null)return prop.number;if(prop.url)return prop.url;if(prop.date)return prop.date?.start||'';if(prop.files?.length){const f=prop.files[0];return f.file?.url||f.external?.url||''}}return''}
    const raw=(g('FORMAT','Type','type')||'POST').toUpperCase()
    let type='POST';if(raw.includes('REEL'))type='REEL';else if(raw.includes('STORY'))type='STORY'
    const dr=g('PUBLIER LE','Publier le','Date','date')
    return{id:page.id,type,caption:g('TITRE','Titre','Caption','Name'),image:g('IMAGE','Image','image','Cover'),emoji:type==='REEL'?'üé¨':type==='STORY'?'‚≠ï':'üñºÔ∏è',likes:parseInt(g("J'AIME","J'aime",'Likes')||0),comments:parseInt(g('COMMENTAIRES','Commentaires','Comments')||0),views:parseInt(g('Views','Vues')||0),date:dr,dateRaw:dr,duration:g('Duration','Dur√©e')}
  }).sort((a,b)=>{if(!a.dateRaw&&!b.dateRaw)return 0;if(!a.dateRaw)return 1;if(!b.dateRaw)return -1;return new Date(b.dateRaw)-new Date(a.dateRaw)})
}

async function fetchN(profile){
  if(!profile.key||!profile.db)return null
  try{
    const res=await fetch('/api/notion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({databaseId:profile.db,notionKey:profile.key})})
    const data=await res.json()
    if(!res.ok){const msgs={unauthorized:'‚ùå Cl√© API invalide.',object_not_found:'‚ùå Base introuvable. V√©rifie l\'ID et que l\'int√©gration est connect√©e.',restricted_resource:'‚ùå Acc√®s refus√©. Ajoute l\'int√©gration via ¬∑¬∑¬∑ > Connections.'};throw new Error(msgs[data.code]||`Erreur : ${data.error||res.status}`)}
    return mapNotion(data.results||[])
  }catch(e){console.error(e);return null}
}

// SETUP
function showSetup(){$('setupOverlay').classList.add('open')}
function hideSetup(){$('setupOverlay').classList.remove('open')}

async function connectNotion(){
  const key=$('cfgKey').value.trim(),db=$('cfgDb').value.trim().replace(/-/g,''),username=$('cfgUsername').value.trim()||'mon_compte',bio=$('cfgBio').value.trim()
  $('setupError').innerHTML=''
  if(!key||!db){$('setupError').innerHTML='<div class="form-error">Renseigne la cl√© et l\'ID.</div>';return}
  if(!key.startsWith('secret_')&&!key.startsWith('ntn_')){$('setupError').innerHTML='<div class="form-error">La cl√© doit commencer par "secret_" ou "ntn_".</div>';return}
  if(db.length!==32){$('setupError').innerHTML=`<div class="form-error">L'ID doit faire 32 caract√®res (actuellement ${db.length}).</div>`;return}
  const btn=$('setupBtn');btn.textContent='Connexion‚Ä¶';btn.disabled=true
  const np={id:uid(),username,displayName:username,bio,link:'',avatar:'üì∑',avatarUrl:'',followers:'0',following:'0',key,db,items:[],storyGroups:[]}
  const items=await fetchN(np)
  btn.textContent='Se connecter √† Notion';btn.disabled=false
  if(!items){$('setupError').innerHTML='<div class="form-error">Connexion √©chou√©e. V√©rifie ta cl√© et l\'ID.</div>';return}
  np.items=items;np.followers=String(items.filter(i=>i.type!=='STORY').length)
  S.profiles.push(np);S.cur=np.id;save();hideSetup()
  $('app').style.display='block';renderAll()
}

function loadDemo(){
  const d={id:'demo',username:'mon.compte',displayName:'Mon Compte Principal',bio:'üöÄ Cr√©ateur de contenu\nüì∏ Planning Instagram\nüìç Paris, France',link:'https://bychanael.fr',avatar:'üì∑',avatarUrl:'',followers:'1 234',following:'567',key:'',db:'',storyGroups:['Voyages','Food'],items:[
    {id:'s1',type:'STORY',caption:'Bonne journ√©e ‚òÄÔ∏è',emoji:'‚òÄÔ∏è',date:'2h',dateRaw:'',likes:0,comments:0,views:842},
    {id:'s2',type:'STORY',caption:'Voyage üó∫Ô∏è',emoji:'üó∫Ô∏è',date:'4h',dateRaw:'',likes:0,comments:0,views:631},
    {id:'s3',type:'STORY',caption:'Food üçù',emoji:'üçù',date:'5h',dateRaw:'',likes:0,comments:0,views:412},
    {id:'p1',type:'POST',caption:'Design ‚ú®',emoji:'üèôÔ∏è',likes:1243,comments:87,dateRaw:'2026-02-20',date:'20 f√©v',image:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&q=80'},
    {id:'r1',type:'REEL',caption:'Tutoriel Figma üé®',emoji:'üé®',likes:4521,comments:203,views:28400,dateRaw:'2026-02-19',date:'19 f√©v',duration:'0:58',image:'https://images.unsplash.com/photo-1561070791-2526d30994b5?w=400&q=80'},
    {id:'p2',type:'POST',caption:'Workspace üñ•Ô∏è',emoji:'üñ•Ô∏è',likes:892,comments:45,dateRaw:'2026-02-18',date:'18 f√©v',image:'https://images.unsplash.com/photo-1587440871875-191322ee64b0?w=600&q=80'},
    {id:'r2',type:'REEL',caption:'Morning routine üåÖ',emoji:'üåÖ',likes:7832,comments:341,views:67200,dateRaw:'2026-02-17',date:'17 f√©v',duration:'0:45',image:'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=400&q=80'},
    {id:'p3',type:'POST',caption:'Travel üåç',emoji:'üåç',likes:2103,comments:128,dateRaw:'2026-02-16',date:'16 f√©v',image:'https://images.unsplash.com/photo-1500835556837-99ac94a94552?w=600&q=80'},
    {id:'p4',type:'POST',caption:'Street üì∏',emoji:'üì∏',likes:1567,comments:94,dateRaw:'2026-02-15',date:'15 f√©v',image:'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=600&q=80'},
    {id:'r3',type:'REEL',caption:'Carbonara üçù',emoji:'üçù',likes:9241,comments:512,views:143000,dateRaw:'2026-02-14',date:'14 f√©v',duration:'2:58',image:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&q=80'},
  ]}
  S.profiles=[d];S.cur='demo';save();hideSetup();$('app').style.display='block';renderAll()
}



async function refreshFeed(){
  const p=curP();if(!p||!p.key)return
  $('contentArea').innerHTML='<div class="ig-loading"><div class="ig-spinner"></div></div>'
  const items=await fetchN(p);if(items){p.items=items;save()}
  renderContent();renderSG()
}

// RENDER
function renderAll(){renderProfile();renderSG();renderTabs();renderContent();renderDD()}

function renderProfile(){
  const p=curP();if(!p)return
  $('appUsername').textContent=p.username||'Instagram'
  const av=$('avInner');if(p.avatarUrl)av.innerHTML=`<img src="${p.avatarUrl}" alt="">`;else av.textContent=p.avatar||'üì∑'
  const stories=(p.items||[]).filter(i=>i.type==='STORY')
  $('avRing').className='ig-av-ring'+(stories.length>0?'':' no-story')
  $('profName').textContent=p.displayName||p.username
  $('profBio').textContent=p.bio||''
  const lnk=$('profLink');if(p.link){lnk.href=p.link;lnk.textContent=p.link.replace(/^https?:\/\//,'');lnk.style.display='inline-block'}else lnk.style.display='none'
  const posts=(p.items||[]).filter(i=>i.type!=='STORY')
  $('statPosts').textContent=posts.length
  $('statFollowers').textContent=p.followers||'0'
  $('statFollowing').textContent=p.following||'0'
}

function renderSG(){
  const p=curP();if(!p)return
  const stories=(p.items||[]).filter(i=>i.type==='STORY')
  const groups=p.storyGroups||[]
  const gdata=[]
  if(stories.length>0)gdata.push({name:p.username||'Stories',items:stories,isAll:true})
  groups.forEach(gn=>gdata.push({name:gn,items:stories.filter(s=>s.caption&&s.caption.toLowerCase().includes(gn.toLowerCase())),isAll:false}))
  const bar=$('sgBar');if(gdata.length===0){bar.classList.remove('visible');return}
  bar.classList.add('visible')
  $('sgInner').innerHTML=gdata.map((g,gi)=>{
    const allSeen=g.items.length>0&&g.items.every(s=>S.seen[s.id])
    const thumb=g.items[0]?.image
    return`<div class="sg-item" onclick="openSGStory(${gi})" style="animation-delay:${gi*0.05}s">
      <div class="sg-ring ${allSeen?'seen':''}">
        <div class="sg-thumb">${thumb?`<img src="${thumb}" alt="" onerror="this.style.display='none'">`:''}${!thumb?(g.isAll?(p.avatarUrl?`<img src="${p.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:p.avatar||'üì∑'):'üìÇ'):''}
        </div>
      </div>
      <span class="sg-name">${g.name}</span>
    </div>`
  }).join('')
}

function openSGStory(gi){
  const p=curP();const stories=(p.items||[]).filter(i=>i.type==='STORY');const groups=p.storyGroups||[]
  const gdata=[];if(stories.length>0)gdata.push({items:stories});groups.forEach(gn=>gdata.push({items:stories.filter(s=>s.caption&&s.caption.toLowerCase().includes(gn.toLowerCase()))}))
  const g=gdata[gi];if(!g||g.items.length===0)return
  openStory(g.items,0)
}

function renderDD(){
  $('ddList').innerHTML=S.profiles.map(p=>`
    <div class="pd-item ${p.id===S.cur?'active':''}" onclick="switchP('${p.id}')">
      <div class="pd-av">${p.avatarUrl?`<img src="${p.avatarUrl}" alt="">`:p.avatar||'üì∑'}</div>
      <div class="pd-info"><div class="pd-name">${p.username}</div><div class="pd-sub">${(p.items||[]).filter(i=>i.type!=='STORY').length} publications</div></div>
      ${p.id===S.cur?'<div class="pd-check">‚úì</div>':''}
    </div>`).join('')
}

function toggleDD(){S.ddOpen=!S.ddOpen;$('profileDD').classList.toggle('open',S.ddOpen);$('logoChevron').style.transform=S.ddOpen?'rotate(180deg)':''}
function switchP(id){S.cur=id;save();toggleDD();renderAll()}
function addProfile(){if(S.ddOpen)toggleDD();$('cfgKey').value='';$('cfgDb').value='';$('cfgUsername').value='';$('cfgBio').value='';$('setupError').innerHTML='';showSetup()}

function renderTabs(){['grid','reels','tagged'].forEach(t=>{$('tab'+t.charAt(0).toUpperCase()+t.slice(1)).className='ig-tab'+(t===S.tab?' active':'')})}
function switchTab(t){S.tab=t;renderTabs();renderContent()}

function renderContent(){
  const p=curP();const el=$('contentArea');if(!p)return
  const all=p.items||[]
  const grid=all.filter(i=>i.type!=='STORY').sort((a,b)=>{if(!a.dateRaw&&!b.dateRaw)return 0;if(!a.dateRaw)return 1;if(!b.dateRaw)return -1;return new Date(b.dateRaw)-new Date(a.dateRaw)})
  const reels=all.filter(i=>i.type==='REEL')
  if(S.tab==='grid'){
    if(grid.length===0){el.innerHTML=emptyH('posts');return}
    const cells=grid.slice(0,50).map((item,i)=>`
      <div class="ig-grid-item" onclick="openPost('${item.id}')" style="animation-delay:${i*0.04}s">
        ${item.image?`<img src="${item.image}" alt="" onerror="this.style.display='none'">`:``}
        <div class="ig-grid-emoji"${item.image?' style="display:none"':''}>${item.emoji}</div>
        ${item.type==='REEL'?`<div class="ig-grid-badge"><svg viewBox="0 0 24 24" fill="white" width="18" height="18"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>`:''}
        <div class="ig-grid-overlay">${item.type==='REEL'?`<span>‚ñ∂ ${fmt(item.views)}</span>`:''}<span>‚ù§ ${fmt(item.likes)}</span><span>üí¨ ${fmt(item.comments)}</span></div>
      </div>`)

    el.innerHTML=`<div class="ig-grid">${cells.join('')}</div>`
  }else if(S.tab==='reels'){
    if(reels.length===0){el.innerHTML=emptyH('reels');return}
    el.innerHTML=`<div class="ig-reels-grid">${reels.map((r,i)=>`
      <div class="ig-reel-item" onclick="openPost('${r.id}')" style="animation-delay:${i*0.05}s">
        ${r.image?`<img src="${r.image}" alt="" onerror="this.style.display='none'">`:``}
        <div class="ig-reel-emoji"${r.image?' style="display:none"':''}>${r.emoji}</div>
        <div class="ig-reel-play"><svg viewBox="0 0 24 24" fill="white" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>
        ${r.views?`<div class="ig-reel-views">‚ñ∂ ${fmt(r.views)}</div>`:''}
      </div>`).join('')}</div>`
  }else{el.innerHTML=emptyH('tagged')}
}

function emptyH(t){const d={posts:['<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="28" height="28"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>','Aucune publication','Les posts appara√Ætront ici.'],reels:['<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="28" height="28"><polygon points="5 3 19 12 5 21 5 3"/></svg>','Aucun Reel','Les reels appara√Ætront ici.'],tagged:['<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="28" height="28"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>','Aucune mention','Les publications appara√Ætront ici.']}[t]
return`<div class="ig-empty"><div class="ig-empty-icon">${d[0]}</div><h3>${d[1]}</h3><p>${d[2]}</p></div>`}

// STORIES
function openFirstStory(){const p=curP();const s=(p?.items||[]).filter(i=>i.type==='STORY');if(s.length>0)openStory(s,0)}
function openStory(items,idx){S.storyItems=items;S.storyIdx=idx;showStory();$('storyModal').classList.add('open')}
function showStory(){
  clearTimeout(S.storyTimer);const s=S.storyItems[S.storyIdx];if(!s){closeStory();return}
  S.seen[s.id]=true;save();renderSG()
  const p=curP();const av=$('storyAv');if(p.avatarUrl)av.innerHTML=`<img src="${p.avatarUrl}" alt="">`;else av.textContent=p.avatar||'üì∑'
  $('storyUname').textContent=p.username||'';$('storyTime').textContent=s.date||''
  const media=$('storyMedia');media.innerHTML=s.image?`<img src="${s.image}" alt="" onerror="this.style.display='none'"><span class="story-big-emoji" style="display:none">${s.emoji}</span>`:`<span class="story-big-emoji">${s.emoji}</span>`
  if(s.caption)media.innerHTML+=`<div class="story-caption">${s.caption}</div>`
  $('storyBars').innerHTML=S.storyItems.map((_,i)=>`<div class="story-bar"><div class="story-bar-fill ${i<S.storyIdx?'done':i===S.storyIdx?'active':''}"></div></div>`).join('')
  S.storyTimer=setTimeout(nextStory,5000)
}
function nextStory(){if(S.storyIdx<S.storyItems.length-1){S.storyIdx++;showStory()}else closeStory()}
function prevStory(){if(S.storyIdx>0){S.storyIdx--;showStory()}}
function closeStory(){clearTimeout(S.storyTimer);$('storyModal').classList.remove('open')}

// POST
function openPost(id){
  const p=curP();const item=(p?.items||[]).find(i=>i.id===id);if(!item)return
  const av=$('postAv');if(p.avatarUrl)av.innerHTML=`<img src="${p.avatarUrl}" alt="">`;else av.textContent=p.avatar||'üì∑'
  $('postUname').textContent=p.username||'';$('postDateLbl').textContent=item.date||''
  $('postMedia').innerHTML=item.image?`<img src="${item.image}" alt="" onerror="this.style.display='none'">`:`<div class="post-big-emoji">${item.emoji}</div>`
  $('postTypeLbl').textContent=item.type==='REEL'?`üé¨ REEL${item.duration?' ¬∑ '+item.duration:''}`:'';
  $('postLikes').textContent=fmt(item.likes);$('postComments').textContent=fmt(item.comments)
  $('postLikesLbl').textContent=fmt(item.likes)+' J\'aime'
  $('postCap').innerHTML=`<strong>${p.username}</strong> ${item.caption||''}`
  $('postCommentsLbl').textContent=item.comments>0?`Voir les ${fmt(item.comments)} commentaires`:''
  $('postModal').classList.add('open')
}
function closePost(){$('postModal').classList.remove('open')}

// EDIT PROFILE
function openEdit(){
  const p=curP();if(!p)return
  $('avPicker').innerHTML=AVATARS.map(a=>`<span class="av-opt ${p.avatar===a?'selected':''}" onclick="selAv(this,'${a}')">${a}</span>`).join('')
  $('editAvUrl').value=p.avatarUrl||'';$('editDisplayName').value=p.displayName||'';$('editUsername').value=p.username||''
  $('editBio').value=p.bio||'';$('editLink').value=p.link||'';$('editFollowers').value=p.followers||'';$('editFollowing').value=p.following||''
  $('editKey').value=p.key||'';$('editDb').value=p.db||'';$('editError').innerHTML=''
  openModal('editModal')
}
function selAv(el,emoji){document.querySelectorAll('.av-opt').forEach(e=>e.classList.remove('selected'));el.classList.add('selected');el.dataset.val=emoji}

async function saveProfile(){
  const p=curP();if(!p)return
  const sel=document.querySelector('.av-opt.selected');p.avatar=sel?.textContent||p.avatar
  p.avatarUrl=$('editAvUrl').value.trim();p.displayName=$('editDisplayName').value.trim()||p.username
  p.username=$('editUsername').value.trim()||p.username;p.bio=$('editBio').value.trim()
  p.link=$('editLink').value.trim();p.followers=$('editFollowers').value.trim();p.following=$('editFollowing').value.trim()
  const nk=$('editKey').value.trim(),nd=$('editDb').value.trim().replace(/-/g,'')
  if(nk&&nd&&(nk!==p.key||nd!==p.db)){
    if(!nk.startsWith('secret_')&&!nk.startsWith('ntn_')){$('editError').innerHTML='<div class="form-error">Cl√© invalide.</div>';return}
    if(nd.length!==32){$('editError').innerHTML='<div class="form-error">ID invalide (32 caract√®res).</div>';return}
    p.key=nk;p.db=nd;const items=await fetchN(p);if(items)p.items=items
  }
  save();closeModal('editModal');renderAll()
}

function deleteProfile(){
  if(S.profiles.length<=1){alert('Tu ne peux pas supprimer le seul profil.');return}
  if(!confirm('Supprimer ce profil ?'))return
  S.profiles=S.profiles.filter(p=>p.id!==S.cur);S.cur=S.profiles[0].id;save();closeModal('editModal');renderAll()
}

// STORY GROUPS
function openSGM(){renderSGM();openModal('sgModal')}
function renderSGM(){
  const p=curP();const groups=p?.storyGroups||[];const stories=(p?.items||[]).filter(i=>i.type==='STORY')
  $('sgmList').innerHTML=groups.length===0?'<div style="color:var(--ig-muted);font-size:13px;text-align:center;padding:12px">Aucun groupe. Cr√©e-en un ci-dessous.</div>':groups.map((g,i)=>{
    const cnt=stories.filter(s=>s.caption&&s.caption.toLowerCase().includes(g.toLowerCase())).length
    return`<div class="sgm-item"><div class="sgm-icon">üìÇ</div><div class="sgm-info"><div class="sgm-name">${g}</div><div class="sgm-count">${cnt} story${cnt>1?'s':''}</div></div><button class="sgm-del" onclick="delSG(${i})">‚úï</button></div>`
  }).join('')
}
function addSG(){const name=$('sgmInput').value.trim();if(!name)return;const p=curP();if(!p.storyGroups)p.storyGroups=[];if(!p.storyGroups.includes(name)){p.storyGroups.push(name);save()};$('sgmInput').value='';renderSGM();renderSG()}
function delSG(i){const p=curP();p.storyGroups.splice(i,1);save();renderSGM();renderSG()}

// MODALS
function openModal(id){$(id).classList.add('open')}
function closeModal(id){$(id).classList.remove('open')}

// Close dropdown on outside click
document.addEventListener('click',e=>{if(S.ddOpen&&!e.target.closest('.ig-logo')&&!e.target.closest('#profileDD')){S.ddOpen=false;$('profileDD').classList.remove('open');$('logoChevron').style.transform=''}})

// INIT
window.addEventListener('load',()=>{
  if(new URLSearchParams(location.search).get('demo')==='1'){loadDemo();return}
  if(load()&&S.profiles.length>0){$('app').style.display='block';renderAll();refreshFeed()}
  else showSetup()
})
</script>
</body>
</html>
